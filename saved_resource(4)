/*! messenger 2013-07-25 */
KISSY.add("tbc/messenger/1.1.0/index",function(a,b,c,d,e,f){function g(a,b){v.push([a,b])}function h(c,d,f){var g={type:c,content:d},h=f;a.isString(f)?(h=b.get("#"+f),f=h.contentWindow):t||u||f.contentWindow&&(f=f.contentWindow),l()?f.KISSY.TBC.Messenger._fire(c,d):t?setTimeout(function(){m.callSWF?m.callSWF("send",[g,k(h)]):m.send(g,k(h))},500):f.postMessage(e.stringify(g),"*")}function i(b,c){a.each(v,function(a){a[0]===b&&a[1](c)})}function j(c,d){var e,f="parentFlash="+w+"&childFlash=_MessengerChildFlash_"+a.now()+"&domain="+document.domain;a.isString(c)?(e=c,c={}):e=c.src,c.src=e+(e.indexOf("?")>-1?"&":"?")+f;var g=b.create("<iframe>",c);return g.setAttribute("width",1),g.setAttribute("height",1),b.get(d||"body").appendChild(g)}function k(a){var b=a.src;if(b){var c=b.match(/childFlash=([^&]+)/);if(c&&c[1])return c[1];throw"iframe has no flashName param"}var d=/parentFlash=([^&]+)/,c=s.match(d);if(c&&c[1])return c[1];throw"iframe has no topFlashName param"}function l(a){var a=a||document.domain,b=/^taobao\.(com|net)$/;return b.test(a)?!0:!1}if(a.TBC&&a.TBC.Messenger)return!1;var m,n=window,o=a.namespace("TBC.Messenger"),p=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),q="1.1.0",r=q?"http://"+(p?"g.tbcdn.cn":"g.assets.daily.taobao.net")+"/tbc/messenger/"+q+"/flash-post-message.swf":"flash-post-message.swf",s=location.search,t="undefined"==typeof postMessage||!n.addEventListener,u=n.top!=n&&s.indexOf("domain")>-1,v=[],w="_MessengerFlash_"+a.now();if(u){var x=/domain=([^&]+)/,y=location.search.match(x);y&&y[1]&&l(y[1])&&(document.domain=p?"taobao.com":"taobao.net")}if(!l())if(t){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;"message"==c&&d&&i(d.type,d.content)};var y=s.match(/childFlash=([^&]+)/);y&&y[1]&&(w=y[1]);var z={src:r,attrs:{width:1,height:1,style:"position:absolute;top:0"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:w},allowscriptaccess:"always"}};parseFloat(a.version,10)>1.2?m=new f(z):a.Flash.add("#J_FlashPostMessageContainer",z,function(a){m=a.swf})}else n.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var d=e.parse(c);i(d.type,d.content)}catch(f){}},!1);return a.mix(o,{register:g,send:h,createIframe:j,_fire:i,flashName:w})},{requires:["dom","event","ua","json",parseFloat(KISSY.version,10)>1.2?"swf":"flash"]});KISSY.add("tbc/umpp/1.3.10/mods/getNick",function(b,a){return function(d){var c=a.get("tracknick")||a.get("lgc");if(!d){return c}return encodeURIComponent(unescape(c).replace(/\\u/g,"%u"))}},{requires:["cookie"]});KISSY.add("tbc/umpp/1.3.10/mods/trinity",function(c,g,b){var f="UM_",e=window;function d(j,h,i,k){this.nk=j;this.tag=f+j+"_data";this.swfurl=h;this.evs=i;this.expireTime=k;this._init()}var a=d.prototype;a._init=function(){var h=this,i={src:h.swfurl,attrs:{width:1,height:1},params:{flashVars:{jsentry:"jsEntry",swfid:f+h.nk+c.now(),group:h.nk},allowscriptaccess:"always"}};e.jsEntry=function(j,o){var l=o.type,n=o.data,k=h.evs,m=k[l];if(m){m.call(h,"message"===l?n:null)}};h.swf=new b(i)};a.clear=function(m){var n=this.get(this.tag);if(n){var l=0,h=n.length,k;for(;l<h;l++){if(n[l]["url"]===m){k=l;break}}if(c.isNumber(k)){n.splice(k,1)}}this.save(this.tag,n);return n};a.save=function(i,j){var h;if(c.isString(j)){j=g.parse(j)}if(/^type\d$/.test(i)){h={t:c.now(),msg:j}}else{h=j}this.swf.callSWF("setItem",[this.tag+(i||""),h]);return j};a.get=function(h){var i=this.swf.callSWF("getItem",[this.tag+h]),j;if(i&&/^type\d$/.test(h)){if(h=="type0"){if(c.now()-i.t<3*60*60*1000){j=i.msg}}else{if(h=="type1"){if(c.now()-i.t<3*60*60*1000){j=i.msg}}else{if(h=="type2"){if(c.now()-i.t<3*60*60*1000){j=i.msg}}}}return j}return i};a.fire=function(h){return this.swf.callSWF("fire",[h])};return d},{requires:["json","swf"]});KISSY.add("tbc/umpp/1.3.10/mods/server",function(g,d,b){var h=75,c=0;function a(m){var k=m.split("}{"),l=m;if(k.length>1){return"{"+k[k.length-1]}return l}function j(o,n){var l={};if(n){l.conn="chunked"}else{if(o.conn){l.conn=o.conn}}var k=o.st,m=[];if(k){g.each(k,function(p){if(p.key){m.push(p.key)}});if(m.length){l.key=m.join("")}}return l}function f(k,o,n,l){var m=new XMLHttpRequest(),p;m.onreadystatechange=function(){var q=m.responseText,r;if(q){r=JSON.parse(a(q));if(3===m.readyState&&"2"==r.type){o(r)}else{if(4===m.readyState){if(200===m.status){n(r);if(p){clearTimeout(p)}}else{l()}}}}};m.open("get",k,true);m.send();p=setTimeout(function(){m.abort();l();p=null},h*1000)}function i(k,l,m){this.nk=k;this.url=l;this.success=m;this.build()}var e=i.prototype;e.build=function(n){var m=this,k=b(),l=m.url+"&t="+g.now();if(n&&n.key){l+="&key="+n.key}if(k!==m.nk){return false}if(n&&"chunked"===n.conn&&(g.UA.ie>9||!g.UA.ie)){f(l+"&stream=true",function(o){m.success(o.st)},function(o){m._checkType(o,true)},function(){setTimeout(function(){m.build({conn:"chunked"})},Math.ceil(Math.random()*40)*1000)})}else{new d({type:"get",url:l,dataType:"json",timeout:h,success:function(o){c=0;m._checkType(o)},error:function(o){if("timeout"===o){m.build()}else{if(++c<5){setTimeout(function(){m.build()},Math.ceil(Math.random()*40)*1000)}}}})}};e._checkType=function(m,l){if(!m){return false}var k=m.type;if("1"==k||"2"==k){this.build(j(m,l));if("2"==k&&m.st){this.success(m.st)}}else{if("5"==k){location.href="http://www.taobao.com/go/act/share/loginsuccess.php"}}};return i},{requires:["ajax","tbc/umpp/1.3.10/mods/getNick"]});KISSY.add("tbc/umpp/1.3.10/mods/tmsg",function(c,a){var e=window;function d(g,f,i,h){this.url=f;this.trinity=i;this.Messenger=h;this.type=g;this._init()}var b=d.prototype;b._init=function(){var f=this,g=f.trinity.get(f.type);if(!g){return f.requestData()}return f.trinity.fire({content:[{t1:"1064",content:g}],identity:"-"})};b.requestData=function(){var f=this;a.jsonp(f.url,function(g){if(g.content){var h=g.content;if(h){if(f.trinity){f.trinity.save(f.type,h);return f.trinity.fire({content:[{t1:"1064",content:h}],identity:"-"})}f.Messenger.send("1064",h,e.parent)}}})};return d},{requires:["ajax"]});KISSY.add("tbc/umpp/1.3.10/connect",function(j,e,t,l,f,a,k,n,h,u,b){var i=window,c=3,m=-1===location.host.indexOf("daily"),p=m?"http://g.tbcdn.cn":"http://g.assets.daily.taobao.net",A="http://i."+(m?"taobao.com":"daily.taobao.net")+"/message/un_read_message_num_new.htm",q="http://i."+(m?"taobao.com":"daily.taobao.net")+"/message/has_LayerTag.htm",o="http://i."+(m?"taobao.com":"daily.taobao.net")+"/message/popupmsg_count.htm",z="1.3.10",C=parseFloat(z)?(p+"/tbc/umpp/"+z+"/trinity.swf"):"trinity.swf",v=location.search.match(/appId=(\d+)/),g=v&&v[1]?v[1]:1064,B="http://mpp."+(m?"taobao.com":"daily.taobao.net:8080")+"/buildconnection.do?ctype=login&appId="+g+"&nkh="+n(),w,x,d=a.fpv()&&1065!=g,y={master:function(){w=new u(n(),B,r)},join:function(){s()},message:function(E){if(!E){return false}var D=E.body;if(!D.identity||"-"===D.identity){j.each(D.content,function(F){k.send(F.t1,F,i.parent)})}}};function s(){var G=x.get("type0"),F=x.get("type1"),E=x.get("type2"),D;if(G||F||E){D=j.merge(G||{},F||{},E||{})}if(D){k.send("1064",{t1:1064,content:D},i.parent)}}function r(D){if(!D||!D.length){return false}if(d){x.fire({content:D,identity:"-"});j.each(D,function(G){var F=G.t1;if("1063"==F){x.fire({content:[G],identity:[n(true),F,"1"].join("-")})}else{if("1064"==F){var E=G.content;if(j.isString(E)){E=e.parse(E)}if(j.isObject(E)){j.each(E,function(J,I){var H={};H[I]=J;x.save(I,H)})}}}})}else{j.each(D,function(E){k.send(E.t1,E,i.parent)})}}return{start:function(){if(d){k.register("save",function(H){var D=H[0],G=H[1],F=H[2],E={};E[D]=G;if("1064"==F){x.save(D,E)}else{x.save(D,G)}if(F){x.fire({content:[{t1:F,content:E}],identity:"-"})}});x=new h(n(true),C,y,c);k.register("get",function(D){k.send(D,x.get(D),i.parent)});k.register("clearTMsg",function(D){var E=x.clear(D);x.fire({content:[{t1:"1064",content:E}],identity:"-"})})}else{if(!t.ie||t.ie>8||1065==g){y.master()}}}}},{requires:["json","ua","cookie","ajax","swf","tbc/messenger/1.1.0/","tbc/umpp/1.3.10/mods/getNick","tbc/umpp/1.3.10/mods/trinity","tbc/umpp/1.3.10/mods/server","tbc/umpp/1.3.10/mods/tmsg"]});
